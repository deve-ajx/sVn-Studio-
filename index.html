<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>sVn Studio - Insta Style Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{--dark:#0b0b0b;--accent:#38bdf8;--light:#e5e7eb;--card:#111;}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
body{background:var(--dark);color:var(--light);overflow-x:hidden}

/* AUTH SCREEN */
#authScreen{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:#000;position:fixed;width:100%;z-index:9999;}
#authScreen input{padding:12px;margin:10px;width:260px;border-radius:8px;border:1px solid var(--accent);background:#111;color:#fff;}
#authScreen button{padding:12px 20px;margin:5px;border:none;border-radius:8px;background:var(--accent);cursor:pointer;font-weight:bold;}
#message{margin-top:10px;color:var(--accent)}
#checkVerificationBtn{padding:10px 20px;margin-top:10px;background:#38bdf8;color:#000;border:none;border-radius:6px;cursor:pointer;}

/* MODALS */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);justify-content:center;align-items:center;z-index:1000;}
.modal-content{background:#111;padding:30px;border-radius:12px;width:320px;text-align:center;}
.modal-content input,.modal-content textarea{width:100%;padding:10px;margin:10px 0;border-radius:6px;border:1px solid #38bdf8;background:#000;color:#fff;}
.modal-content button{padding:10px 20px;background:#38bdf8;color:#000;border:none;border-radius:6px;cursor:pointer;}

/* HEADER / TOP BAR */
header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:#111;position:sticky;top:0;z-index:100;border-bottom:1px solid #222;}
header .logo{height:40px;border-radius:50%;}
header .top-icons{display:flex;align-items:center;gap:15px;}
header .top-icons img{width:35px;height:35px;border-radius:50%;cursor:pointer;object-fit:cover;}

/* STORIES BAR */
#stories{display:flex;overflow-x:auto;padding:10px 0;margin:10px 0;}
.story{display:flex;flex-direction:column;align-items:center;margin:0 10px;cursor:pointer;}
.story img{width:60px;height:60px;border-radius:50%;border:2px solid var(--accent);}
.story span{margin-top:5px;font-size:0.8rem;color:#ccc;}

/* FEED */
#feed{display:flex;flex-direction:column;gap:15px;}
.post{background:var(--card);border-radius:12px;overflow:hidden;}
.post-header{display:flex;align-items:center;gap:10px;padding:10px;}
.post-header img{width:40px;height:40px;border-radius:50%;object-fit:cover;}
.post-header span{font-weight:bold;}
.post-content img{width:100%;display:block;}
.post-actions{padding:10px;display:flex;gap:15px;align-items:center;}
.post-actions i{cursor:pointer;transition:0.2s;}
.post-actions i:hover{transform:scale(1.2);}
.post-comments{padding:0 10px 10px 10px;}
.comment{margin-top:5px;background:#222;padding:5px;border-radius:6px;position:relative;}
.comment .delete-btn{position:absolute;top:2px;right:2px;background:red;color:#fff;border:none;border-radius:4px;padding:2px 4px;cursor:pointer;font-size:0.7rem;}

/* FOOTER */
footer{background:#111;padding:20px;text-align:center;color:#999;margin-top:20px;}
</style>
</head>

<body>

<!-- AUTH SCREEN -->
<div id="authScreen">
<h2>sVn Studio Members Access</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<div>
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
</div>
<button id="checkVerificationBtn">I verified my email</button>
<p id="message"></p>
</div>

<!-- USERNAME MODAL -->
<div class="modal" id="usernameModal">
<div class="modal-content">
<h3>Pick a Username</h3>
<input type="text" id="newUsername" placeholder="Enter username">
<button id="saveUsername">Save</button>
</div>
</div>

<!-- PROFILE EDIT MODAL -->
<div class="modal" id="editProfileModal">
<div class="modal-content">
<h3>Edit Profile</h3>
<img id="profilePreview" src="" alt="Profile Picture">
<input type="file" id="profilePicInput">
<input type="text" id="profileUsername" placeholder="Username">
<textarea id="profileBio" placeholder="Bio"></textarea>
<button id="saveProfileBtn">Save Profile</button>
<button id="closeProfileBtn" style="background:red;margin-top:10px;">Close</button>
</div>
</div>

<!-- VIEW PROFILE MODAL -->
<div class="modal" id="viewProfileModal">
<div class="modal-content">
<img id="viewProfilePic" src="" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">
<h3 id="viewUsername"></h3>
<p id="viewBio"></p>
<button id="closeViewProfileBtn" style="background:red;margin-top:10px;">Close</button>
</div>
</div>

<!-- MAIN SITE -->
<div id="mainSite">
<header>
<img class="logo" src="https://res.cloudinary.com/dm6k0etap/image/upload/v1769549277/0919b84a-9700-465e-8827-3a4e24a11790_idxg1u.jpg">
<div class="top-icons">
<img id="editProfileBtn" src="https://via.placeholder.com/35" title="Edit Profile">
<a id="logoutBtn" style="color:red;">Logout</a>
</div>
</header>

<!-- Stories -->
<div id="stories"></div>

<!-- Feed -->
<div id="feed"></div>

<footer>© 2026 sVn Studio Tech Agency — Insta Style Feed</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, getDoc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
apiKey: "AIzaSyD0CpkbFpoKPvB1akarURWyzwiwftOiq5g",
authDomain: "studio-1d6b7.firebaseapp.com",
projectId: "studio-1d6b7",
storageBucket: "studio-1d6b7.firebasestorage.app",
messagingSenderId: "808981598394",
appId: "1:808981598394:web:fe6789050b9a39e288f283"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const authScreen = document.getElementById("authScreen");
const mainSite = document.getElementById("mainSite");
const email = document.getElementById("email");
const password = document.getElementById("password");
const message = document.getElementById("message");
const loginBtn = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");
const logoutBtn = document.getElementById("logoutBtn");
const checkVerificationBtn = document.getElementById("checkVerificationBtn");

const usernameModal = document.getElementById("usernameModal");
const newUsername = document.getElementById("newUsername");
const saveUsername = document.getElementById("saveUsername");

const editProfileModal = document.getElementById("editProfileModal");
const editProfileBtn = document.getElementById("editProfileBtn");
const closeProfileBtn = document.getElementById("closeProfileBtn");
const profilePreview = document.getElementById("profilePreview");
const profilePicInput = document.getElementById("profilePicInput");
const profileUsername = document.getElementById("profileUsername");
const profileBio = document.getElementById("profileBio");
const saveProfileBtn = document.getElementById("saveProfileBtn");

const storiesDiv = document.getElementById("stories");
const feedDiv = document.getElementById("feed");

const viewProfileModal = document.getElementById("viewProfileModal");
const viewProfilePic = document.getElementById("viewProfilePic");
const viewUsername = document.getElementById("viewUsername");
const viewBio = document.getElementById("viewBio");
const closeViewProfileBtn = document.getElementById("closeViewProfileBtn");

// --- AUTH ---
loginBtn.onclick = async () => {
  try{
    const userCred = await signInWithEmailAndPassword(auth,email.value,password.value);
    await userCred.user.reload();
    if(!userCred.user.emailVerified){ message.innerText="Verify your email before login!"; return; }
  } catch(err){ message.innerText=err.message; }
};

signupBtn.onclick = async () => {
  try{
    const userCred = await createUserWithEmailAndPassword(auth,email.value,password.value);
    await sendEmailVerification(userCred.user);
    message.innerText="Account created! Check your email to verify.";
  } catch(err){ message.innerText=err.message; }
};

checkVerificationBtn.onclick = async ()=>{
  const user = auth.currentUser;
  if(user){ await user.reload(); if(user.emailVerified){ message.innerText="Email verified! Reloading site..."; } else { message.innerText="Email not verified yet!"; } }
};

logoutBtn.onclick = async ()=>{ await signOut(auth); };

// --- ON AUTH STATE ---
onAuthStateChanged(auth, async user=>{
  if(user && user.emailVerified){
    authScreen.style.display="none"; mainSite.style.display="block";

    // Check username
    const userDoc = await getDoc(doc(db,"users",user.uid));
    if(!userDoc.exists()){ usernameModal.style.display="flex"; }
    else{ usernameModal.style.display="none"; loadStoriesAndFeed(); }

    // Preload profile modal
    if(userDoc.exists()){
      const data = userDoc.data();
      profilePreview.src = data.photoURL || "https://via.placeholder.com/80";
      profileUsername.value = data.username || "";
      profileBio.value = data.bio || "";
    }
  } else { authScreen.style.display="flex"; mainSite.style.display="none"; usernameModal.style.display="none"; }
});

// --- USERNAME ---
saveUsername.onclick = async ()=>{
  const name = newUsername.value.trim(); if(!name) return alert("Enter a username!");
  const user = auth.currentUser; await setDoc(doc(db,"users",user.uid),{ username:name });
  usernameModal.style.display="none"; loadStoriesAndFeed();
};

// --- PROFILE EDIT ---
editProfileBtn.onclick = ()=>{ editProfileModal.style.display="flex"; }
closeProfileBtn.onclick = ()=>{ editProfileModal.style.display="none"; }
profilePicInput.onchange = e=>{ if(e.target.files && e.target.files[0]) profilePreview.src = URL.createObjectURL(e.target.files[0]); }

saveProfileBtn.onclick = async ()=>{
  const user = auth.currentUser; if(!user) return;
  let photoURL = profilePreview.src;
  if(profilePicInput.files.length>0){
    const file = profilePicInput.files[0];
    const storageRef = ref(storage, `profile_pics/${user.uid}`);
    await uploadBytes(storageRef,file);
    photoURL = await getDownloadURL(storageRef);
  }
  await setDoc(doc(db,"users",user.uid),{
    username: profileUsername.value.trim(),
    bio: profileBio.value.trim(),
    photoURL
  },{ merge:true });
  profilePreview.src = photoURL; editProfileModal.style.display="none"; loadStoriesAndFeed();
};

// --- VIEW PROFILE MODAL ---
closeViewProfileBtn.onclick = ()=>{ viewProfileModal.style.display="none"; }

// --- LOAD STORIES + FEED ---
async function loadStoriesAndFeed(){
  storiesDiv.innerHTML=""; feedDiv.innerHTML="";
  const usersSnap = await getDocs(collection(db,"users"));
  usersSnap.forEach(docSnap=>{
    const data = docSnap.data();

    // Stories
    const storyDiv = document.createElement("div"); storyDiv.classList.add("story");
    storyDiv.innerHTML=`<img src="${data.photoURL||'https://via.placeholder.com/60'}"><span>${data.username||'Anon'}</span>`;
    storyDiv.onclick = ()=>{
      viewProfilePic.src = data.photoURL||'https://via.placeholder.com/100';
      viewUsername.innerText = data.username||'Anon';
      viewBio.innerText = data.bio||'';
      viewProfileModal.style.display="flex";
    };
    storiesDiv.appendChild(storyDiv);

    // Feed Post (example)
    const postDiv = document.createElement("div"); postDiv.classList.add("post");
    postDiv.innerHTML=`
      <div class="post-header"><img src="${data.photoURL||'https://via.placeholder.com/40'}"><span>${data.username||'Anon'}</span></div>
      <div class="post-content"><img src="${data.photoURL||'https://via.placeholder.com/300x300'}"></div>
      <div class="post-actions"><i class="fas fa-heart"></i><i class="fas fa-comment"></i></div>
      <div class="post-comments" id="comments-${docSnap.id}"></div>`;
    feedDiv.appendChild(postDiv);

    // Load comments for this user post
    const commentsQuery = query(collection(db,"comments"), orderBy("timestamp","asc"));
    onSnapshot(commentsQuery,(snapshot)=>{
      const commentContainer = document.getElementById(`comments-${docSnap.id}`);
      if(!commentContainer) return;
      commentContainer.innerHTML="";
      snapshot.forEach(async cSnap=>{
        const cData = cSnap.data(); let uname="Anon";
        try{ const uDoc=await getDoc(doc(db,"users",cData.uid)); if(uDoc.exists()) uname=uDoc.data().username; } catch(e){}
        const cDiv=document.createElement("div"); cDiv.classList.add("comment");
        cDiv.innerHTML=`<strong>${uname}</strong>: ${cData.text}`;
        if(auth.currentUser && auth.currentUser.uid===cData.uid){
          const delBtn=document.createElement("button"); delBtn.classList.add("delete-btn"); delBtn.textContent="Delete";
          delBtn.onclick=async()=>{ await deleteDoc(doc(db,"comments",cSnap.id)); };
          cDiv.appendChild(delBtn);
        }
        commentContainer.appendChild(cDiv);
      });
    });
  });
}
</script>
</body>
</html>