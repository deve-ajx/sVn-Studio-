<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>sVn Tech Agency - Members</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
:root{
  --dark:#0b0b0b;
  --accent:#38bdf8;
  --light:#e5e7eb;
  --card-bg:rgba(20,20,20,0.85);
}
body{margin:0;font-family:'Segoe UI',sans-serif;background:var(--dark);color:var(--light);}
#authScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#000;}
input,textarea{padding:10px;margin:8px;border-radius:6px;border:1px solid var(--accent);background:#111;color:#fff;width:250px;}
button{padding:10px 18px;margin:5px;border:none;border-radius:6px;background:var(--accent);cursor:pointer;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;z-index:1000;}
.modal.show{display:flex;}
.modal-content{background:#111;padding:20px;border-radius:12px;text-align:center;width:320px;}
#profilePreview{width:120px;height:120px;border-radius:50%;object-fit:cover;margin-bottom:10px;}
.member-card{background:var(--card-bg);padding:12px;border-radius:12px;margin-bottom:12px;display:flex;align-items:center;gap:12px;cursor:pointer;}
.member-card img{width:50px;height:50px;border-radius:50%;object-fit:cover;}
.delete-btn{position:absolute;top:10px;right:10px;background:red;color:#fff;border:none;padding:4px 8px;border-radius:5px;cursor:pointer;}
</style>
</head>
<body>

<div id="authScreen">
<h2>sVn Studio Members Access</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<div>
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
</div>
<button id="checkVerificationBtn">I verified my email</button>
<p id="message"></p>
</div>

<div class="modal" id="usernameModal">
<div class="modal-content">
<h3>Pick a Username</h3>
<input type="text" id="newUsername" placeholder="Enter username">
<button id="saveUsername">Save</button>
</div>
</div>

<div class="modal" id="editProfileModal">
<div class="modal-content">
<h3>Edit Profile</h3>
<img id="profilePreview" src="https://via.placeholder.com/120">
<input type="file" id="profilePicInput">
<div id="cropContainer" style="display:none;">
<img id="cropImage" style="max-width:100%;">
<button id="cropBtn">Crop</button>
</div>
<input type="text" id="profileUsername" placeholder="Username">
<textarea id="profileBio" placeholder="Bio"></textarea>
<button id="saveProfileBtn">Save Profile</button>
<button id="closeProfileBtn" style="background:red;margin-top:10px;">Close</button>
</div>
</div>

<div id="mainSite" style="display:none;">
<header>
<img class="logo" src="https://res.cloudinary.com/dm6k0etap/image/upload/v1769549277/0919b84a-9700-465e-8827-3a4e24a11790_idxg1u.jpg">
<nav>
<a id="editProfileBtn">Edit Profile</a>
<a id="logoutBtn" style="color:red;">Logout</a>
</nav>
</header>

<div id="membersPage">
<h2>Members</h2>
<div id="membersList"></div>
</div>
<section id="commentsSection">
<h2>Members Only Comments</h2>
<textarea id="commentInput" rows="3"></textarea>
<button class="btn" id="postCommentBtn">Post Comment</button>
<div id="commentBox"></div>
</section>
<footer>© 2026 sVn Studio Tech Agency — Modern • Clean • Powerful</footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {apiKey:"AIzaSyD0CpkbFpoKPvB1akarURWyzwiwftOiq5g",authDomain:"studio-1d6b7.firebaseapp.com",projectId:"studio-1d6b7",storageBucket:"studio-1d6b7.firebasestorage.app",messagingSenderId:"808981598394",appId:"1:808981598394:web:fe6789050b9a39e288f283"};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const authScreen=document.getElementById("authScreen");
const mainSite=document.getElementById("mainSite");
const email=document.getElementById("email");
const password=document.getElementById("password");
const message=document.getElementById("message");
const loginBtn=document.getElementById("loginBtn");
const signupBtn=document.getElementById("signupBtn");
const logoutBtn=document.getElementById("logoutBtn");
const checkVerificationBtn=document.getElementById("checkVerificationBtn");

const usernameModal=document.getElementById("usernameModal");
const newUsername=document.getElementById("newUsername");
const saveUsername=document.getElementById("saveUsername");

const editProfileModal=document.getElementById("editProfileModal");
const editProfileBtn=document.getElementById("editProfileBtn");
const closeProfileBtn=document.getElementById("closeProfileBtn");
const profilePreview=document.getElementById("profilePreview");
const profilePicInput=document.getElementById("profilePicInput");
const profileUsername=document.getElementById("profileUsername");
const profileBio=document.getElementById("profileBio");
let cropper;

const membersList=document.getElementById("membersList");
const viewProfileModal=document.getElementById("viewProfileModal");
const viewProfilePic=document.getElementById("viewProfilePic");
const viewUsername=document.getElementById("viewUsername");
const viewBio=document.getElementById("viewBio");
const closeViewProfileBtn=document.getElementById("closeViewProfileBtn");

const commentInput=document.getElementById("commentInput");
const postCommentBtn=document.getElementById("postCommentBtn");
const commentBox=document.getElementById("commentBox");

// AUTH
loginBtn.onclick=async()=>{
try{const userCred=await signInWithEmailAndPassword(auth,email.value,password.value);await userCred.user.reload();
if(!userCred.user.emailVerified){message.innerText="Verify your email before login!";return;}}catch(err){message.innerText=err.message;}
};
signupBtn.onclick=async()=>{try{const userCred=await createUserWithEmailAndPassword(auth,email.value,password.value);await sendEmailVerification(userCred.user);message.innerText="Account created! Check email to verify.";}catch(err){message.innerText=err.message;}};
checkVerificationBtn.onclick=async()=>{const user=auth.currentUser;if(user){await user.reload();message.innerText=user.emailVerified?"Email verified! Reloading site...":"Email not verified yet!";}};
logoutBtn.onclick=async()=>{await signOut(auth);};

// ON AUTH STATE
onAuthStateChanged(auth,async(user)=>{
if(user&&user.emailVerified){
authScreen.style.display="none";
mainSite.style.display="block";
const userDoc=await getDoc(doc(db,"users",user.uid));
if(!userDoc.exists()){usernameModal.classList.add("show");} 
else {
usernameModal.classList.remove("show");
const data=userDoc.data();
profilePreview.src=data.photoURL||"https://via.placeholder.com/120";
profileUsername.value=data.username||"";
profileBio.value=data.bio||"";
}
loadMembers();
} else {authScreen.style.display="flex";mainSite.style.display="none";usernameModal.classList.remove("show");}
});

// SAVE USERNAME
saveUsername.onclick=async()=>{
const name=newUsername.value.trim();if(!name)return alert("Enter a username!");
const user=auth.currentUser;
await setDoc(doc(db,"users",user.uid),{username:name},{merge:true});
profileUsername.value=name; // update profile input
usernameModal.classList.remove("show");
};

// PROFILE EDIT
editProfileBtn.onclick=()=>{editProfileModal.classList.add("show");};
closeProfileBtn.onclick=()=>{editProfileModal.classList.remove("show");};

// CROPPER
profilePicInput.onchange=(e)=>{
if(e.target.files && e.target.files[0]){
const url=URL.createObjectURL(e.target.files[0]);
profilePreview.src=url;
if(cropper)cropper.destroy();
cropper=new Cropper(profilePreview,{aspectRatio:1,viewMode:1,autoCropArea:1});
}
};

// SAVE PROFILE
saveProfileBtn.onclick=async()=>{
const user=auth.currentUser;if(!user)return;
let photoURL=profilePreview.src;
if(cropper){const canvas=cropper.getCroppedCanvas({width:200,height:200});canvas.toBlob(async(blob)=>{
const storageRef=ref(storage,`profile_pics/${user.uid}`);
await uploadBytes(storageRef,blob);
photoURL=await getDownloadURL(storageRef);
await setDoc(doc(db,"users",user.uid),{
username:profileUsername.value.trim(),
bio:profileBio.value.trim(),
photoURL
},{merge:true});
profilePreview.src=photoURL;
cropper.destroy();
editProfileModal.classList.remove("show");
loadMembers();
});} else {
await setDoc(doc(db,"users",user.uid),{
username:profileUsername.value.trim(),
bio:profileBio.value.trim(),
photoURL
},{merge:true});
editProfileModal.classList.remove("show");
loadMembers();
}};

// MEMBERS
async function loadMembers(){
membersList.innerHTML="";
const usersSnap=await getDocs(collection(db,"users"));
usersSnap.forEach(docSnap=>{
const data=docSnap.data();
const div=document.createElement("div");
div.classList.add("member-card");
div.innerHTML=`<img src="${data.photoURL||'https://via.placeholder.com/50'}"><span>${data.username||'Anonymous'}</span>`;
div.onclick=()=>{
viewProfilePic.src=data.photoURL||'https://via.placeholder.com/100';
viewUsername.innerText=data.username||'Anonymous';
viewBio.innerText=data.bio||'';
viewProfileModal.classList.add("show");
};
membersList.appendChild(div);
});
}

// VIEW PROFILE
closeViewProfileBtn.onclick=()=>{viewProfileModal.classList.remove("show");};

// COMMENTS
postCommentBtn.onclick=async()=>{const text=commentInput.value.trim();if(!text)return;const user=auth.currentUser;if(!user)return;await addDoc(collection(db,"comments"),{uid:user.uid,text,timestamp:new Date()});commentInput.value="";};
const commentsQuery=query(collection(db,"comments"),orderBy("timestamp","asc"));
onSnapshot(commentsQuery,(snapshot)=>{commentBox.innerHTML="";snapshot.forEach(async docSnap=>{const data=docSnap.data();const id=docSnap.id;let usernameDisplay="Anonymous";try{const userDoc=await getDoc(doc(db,"users",data.uid));if(userDoc.exists())usernameDisplay=userDoc.data().username;}catch(e){};const div=document.createElement("div");div.classList.add("comment");div.innerHTML=`<strong>${usernameDisplay}</strong>: ${data.text}`;if(auth.currentUser && auth.currentUser.uid===data.uid){const delBtn=document.createElement("button");delBtn.classList.add("delete-btn");delBtn.textContent="Delete";delBtn.onclick=async()=>{await deleteDoc(doc(db,"comments",id));};div.appendChild(delBtn);}commentBox.appendChild(div);});});
</script>
</body>
</html>